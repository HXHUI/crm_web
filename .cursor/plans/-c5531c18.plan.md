<!-- c5531c18-c556-4392-8832-82435ec08089 b102605f-037d-45e0-890b-dc8ac8bfda4f -->
# 天眼查工商信息集成方案

## 一、数据库设计

### 1.1 创建工商信息实体 (`business-info.entity.ts`)

- 主表：存储基本工商信息
- 字段：统一社会信用代码、企业名称、法定代表人、经营状态、注册资本、实缴资本、工商注册号、组织机构代码、成立日期、企业类型、营业期限、登记机关、核准日期、注册地址、经营范围
- 关联：与 `Customer` 实体建立一对一关系
- 缓存字段：`lastSyncTime`（最后同步时间）、`expiresAt`（过期时间，默认30天）

### 1.2 创建子实体

- `business-personnel.entity.ts`：主要人员（姓名、职务）
- `business-shareholder.entity.ts`：股东信息（股东名称、持股比例、股东类型、投资金额）
- `business-branch.entity.ts`：分支机构（公司名称、负责人、成立时间、经营状态）
- `business-investment.entity.ts`：对外投资（被投资企业、股东类型、持股比例、投资金额）
- `business-change-record.entity.ts`：变更记录（变更日期、变更事项、变更前、变更后）

## 二、后端实现

### 2.1 创建天眼查服务模块 (`tianyancha/`)

- `tianyancha.service.ts`：封装天眼查API调用
- `queryByCompanyName(name: string)`：通过公司名称查询
- `queryByCreditCode(code: string)`：通过统一社会信用代码查询
- 数据转换：将天眼查返回的数据转换为系统内部格式
- `tianyancha.module.ts`：模块配置
- `dto/tianyancha.dto.ts`：天眼查API请求/响应DTO

### 2.2 创建工商信息服务模块 (`business-info/`)

- `business-info.service.ts`：
- `getBusinessInfo(customerId: number)`：获取工商信息（优先从缓存读取）
- `refreshBusinessInfo(customerId: number, force?: boolean)`：刷新工商信息
- `checkAndRefreshIfExpired(customerId: number)`：检查是否过期，过期则自动刷新
- 过期策略：默认30天过期，可通过配置调整
- `business-info.controller.ts`：
- `GET /business-info/:customerId`：获取工商信息
- `POST /business-info/:customerId/refresh`：手动刷新工商信息
- `business-info.module.ts`：模块配置，依赖 `TianyanchaModule`

### 2.3 缓存策略实现

- 首次查询：调用天眼查API，存储到数据库
- 后续查询：从数据库读取，检查 `expiresAt`
- 过期检查：如果 `expiresAt < now`，自动调用API更新
- 手动刷新：用户主动触发，强制调用API更新

## 三、前端实现

### 3.1 创建API接口 (`api/business-info.ts`)

- `getBusinessInfo(customerId: number)`：获取工商信息
- `refreshBusinessInfo(customerId: number)`：刷新工商信息

### 3.2 更新客户详情页 (`CustomerList.vue`)

- 在左侧导航添加工商信息tab（放在订单tab之后）
- 创建工商信息内容区域，包含6个子tab：
- 工商信息：使用 `el-descriptions` 展示基本信息
- 主要人员：表格展示人员列表
- 股东信息：表格展示股东列表
- 分支机构：表格展示分支机构列表
- 对外投资：表格展示投资列表
- 变更记录：表格展示变更记录列表
- 添加刷新按钮：在工商信息tab标题旁添加刷新按钮，显示最后更新时间
- 自动过期检查：打开工商信息tab时，检查数据是否过期，过期则提示用户刷新

### 3.3 数据加载逻辑

- 打开工商信息tab时，调用 `getBusinessInfo` API
- 如果返回的数据过期，显示提示："数据已过期，点击刷新获取最新信息"
- 点击刷新按钮时，调用 `refreshBusinessInfo` API，显示加载状态
- 刷新成功后，更新显示的数据和最后更新时间

## 四、配置管理

### 4.1 环境变量配置

- `TIANYANCHA_API_KEY`：天眼查API密钥
- `TIANYANCHA_API_URL`：天眼查API地址
- `BUSINESS_INFO_CACHE_DAYS`：缓存过期天数（默认30天）

### 4.2 错误处理

- API调用失败：显示错误提示，保留旧数据
- 数据解析失败：记录日志，显示友好错误信息
- 网络超时：重试机制（最多3次）

## 五、实施步骤

1. 创建数据库实体和迁移文件（工商信息主表和子表，可选扩展Lead实体）
2. 实现天眼查服务模块（封装API调用，包括搜索接口）
3. 实现工商信息服务模块（缓存逻辑）
4. 创建API接口和控制器（包括搜索接口）
5. 前端创建API接口文件
6. 前端更新客户详情页，添加工商信息tab
7. 前端更新线索创建表单，添加企业搜索功能
8. 实现数据展示和刷新功能
9. 测试和优化

## 六、优化建议

- 批量查询：如果多个客户需要更新，可以考虑批量调用（如果天眼查支持）
- 异步更新：对于过期数据，可以在后台异步更新，不阻塞用户查看
- 数据对比：刷新时对比新旧数据，如果有变化才更新数据库
- 使用统计：记录API调用次数，便于成本控制

### To-dos

- [ ] 创建工商信息主实体和所有子实体（主要人员、股东信息、分支机构、对外投资、变更记录）
- [ ] 创建天眼查服务模块，封装API调用逻辑（支持公司名称和统一社会信用代码查询）
- [ ] 创建工商信息服务模块，实现缓存策略（数据库存储、过期检查、自动/手动刷新）
- [ ] 创建工商信息API控制器，提供获取和刷新接口
- [ ] 创建前端API接口文件（business-info.ts），定义获取和刷新接口
- [ ] 在客户详情页添加工商信息tab，包含6个子tab（工商信息、主要人员、股东信息、分支机构、对外投资、变更记录）
- [ ] 实现手动刷新功能和自动过期检查逻辑，显示最后更新时间